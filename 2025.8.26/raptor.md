## 是什么？
简单来说，是一个用于召回更优质内容的东西。
复杂来说，Raptor是一个用于提高RAG任务检索效率的构建、搜索方法。全称为递归抽象处理树组织检索（Recursive Abstractive Processing for Tree Organized Retrieval）通过对文本块进行聚类和建立树形结构，提高大模型搜索检索的效率和效果。

## 怎么做到的？
### 怎么生成查询内容
1.文本分段和嵌入：将输入的文档内容（语料库）分割成连续的文本块（长度为100个词/可以调整），并且使用SBERT对这些文本块进行嵌入。
2.聚类：使用高斯混合模型（GMM）对嵌入后的文本块进行聚类。GMM假设数据点由多个高斯分布混合生成：
$P(x|k) = \mathcal{N}(x;\mu_k,\sum_k)$
3.总结：对聚类后的文本块使用语言模型进行总结，生成简洁且连贯的摘要。
4.树构建：重复嵌入、聚类和总结的过程，直到进一步聚类变得不可行，从而形成一个结构化的多层次书表示。

### 怎么查询生成内容
![b23e36a96b684df2c249eb3cef2730b3.png](:/a4b989009480472dbc2ccec471e9d1cb)
第一种是保持树结构，在查询时按照树结构，从根节点开始分层检索。这种检索实现比较复杂，而且对于多路召回并不友好。

第二种是把树状结构平铺，统一检索。这种实现比较简单，而且很方便跟多路召回融合在一起。

根据论文的实验结果，推荐采用第二种，因此 RAGFlow 也直接采用了平铺结构。具体实现中，RAGFlow 在基于Deepdoc 的文档解析预处理阶段完成后，可选择性的打开 RAPTOR 开关进行聚类并生成摘要，随后把这些生成的内容跟原始的 Chunking 结果合并，然后共同送到数据库，分别建立全文索引和向量索引，后续的操作跟常规的 RAG 没有区别。

## 什么场景有用？
—— 信息密集、结构松散、主题复杂的长文本。

### 1. 科研论文 / 学术文献
比如一篇 20 页的机器学习论文，包含：
数学推导、实验细节、图表说明、引用背景、讨论段落
特点：
信息高度密集
段落之间逻辑跳跃大
没有清晰的小标题结构
RAPTOR 的优势：
自动把“实验设置”相关的 chunk 聚在一起
把“理论证明”部分形成一个子树
最终形成“方法—实验—结论”的语义树，便于检索“作者用了什么数据集？”这类问题
效果显著原因：论文不是为“被检索”写的，但 RAPTOR 把它重构成一个可导航的知识树。

### 2. 技术文档 / 手册 / API 文档
比如 PyTorch 官方文档，包含：
函数说明、参数列表、代码示例、注意事项、版本变更
问题：
内容分散在多个页面
同一个主题（如“分布式训练”）分布在不同章节
RAPTOR 能：
将所有与 DistributedDataParallel 相关的文本聚类
生成高层摘要：“PyTorch 分布式训练的核心是 DDP，需设置 init_method 和 rank”
形成“分布式训练”子树，方便问答
优势：跨章节、跨页面的主题聚合，传统检索做不到。

### 3. 会议纪要 / 多人访谈 / 语音转录
这类文本：
口语化、重复多、逻辑跳跃
没有段落结构，比如：
“我们上周说要优化登录页……对，张伟提过性能问题……李娜说 UX 也要改……还有那个第三方登录……” 
RAPTOR 会：
把所有“登录页”相关句子聚类
把“性能优化”相关归为一类
最终形成“产品需求—技术挑战—负责人”的树结构
反直觉但有效：看似杂乱的对话，被自动组织成结构化知识。

### 4. 法律文件 / 合同 / 政策文本
如一份 100 页的并购合同，包含：
条款、定义、例外、附件、法律管辖
传统检索：搜“termination”可能返回 20 个分散段落
RAPTOR：
自动聚类所有“终止条款”
生成摘要：“合同可在违约后 30 天内终止，需书面通知”
构建“权利—义务—违约—终止”语义路径
价值：从“文本检索”升级为“逻辑结构理解”。

### 5. 长篇报告（如行业分析、政府白皮书）
信息量大、主题多、数据密集
RAPTOR 能自动识别：
“市场趋势” vs “技术挑战” vs “政策建议”
并构建层级导航树

## 会有什么麻烦
- 本来就召回了3个chunk而已，这样重复的概率会非常大
   - 先查高层节点：快速判断“是否相关”
   - 如果相关，再展开子节点获取细节
   - 避免多个相似 chunk 同时被召回
- 我们切片的token大小要怎么分？
- k设定是什么，是不是每个文件都要不同？
   - 不用固定 K，用层次聚类 + 距离阈值 / LLM 一致性判断自动停止  
